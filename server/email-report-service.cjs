/**
 * Email Report Service
 * Generates and sends HTML email reports for savings records
 */

/**
 * Generate HTML email report for savings records
 */
const generateSavingsEmailReport = (records, totalSavings, goalName = 'Savings Records') => {
  const timestamp = new Date().toLocaleString('en-MY');
  const today = new Date().toLocaleDateString('en-MY', { year: 'numeric', month: 'long', day: 'numeric' });

  const recordsHtml = records.map((record, idx) => `
    <tr>
      <td style="padding: 12px; border-bottom: 1px solid #eee; text-align: center;">${idx + 1}</td>
      <td style="padding: 12px; border-bottom: 1px solid #eee;">RM ${record.amount.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
      <td style="padding: 12px; border-bottom: 1px solid #eee;">${record.record_date || 'N/A'}</td>
      <td style="padding: 12px; border-bottom: 1px solid #eee;">${record.notes || '-'}</td>
    </tr>
  `).join('');

  const html = `
    <!DOCTYPE html>
    <html>
    <head>
      <meta charset="UTF-8">
      <style>
        body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }
        .container { max-width: 800px; margin: 0 auto; padding: 20px; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        .header h1 { margin: 0; font-size: 24px; }
        .header p { margin: 5px 0 0 0; font-size: 14px; opacity: 0.9; }
        .summary { background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .summary-row { display: flex; justify-content: space-between; margin: 8px 0; font-size: 14px; }
        .summary-label { font-weight: bold; }
        .summary-value { color: #667eea; font-weight: bold; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; background: white; }
        th { background: #667eea; color: white; padding: 12px; text-align: left; font-weight: bold; }
        td { padding: 12px; border-bottom: 1px solid #eee; }
        tr:hover { background: #f8f9fa; }
        .footer { text-align: center; padding: 20px 0; border-top: 1px solid #eee; color: #666; font-size: 12px; }
        .report-info { background: #e3f2fd; padding: 10px; border-radius: 5px; margin-bottom: 20px; font-size: 13px; }
      </style>
    </head>
    <body>
      <div class="container">
        <div class="header">
          <h1>ðŸ’° Savings Records Report</h1>
          <p>NUR Investment Fund - Savings & Cash Management</p>
        </div>

        <div class="report-info">
          <strong>Report Generated:</strong> ${timestamp}<br>
          <strong>Report Period:</strong> ${today}
        </div>

        <div class="summary">
          <div class="summary-row">
            <span class="summary-label">Goal / Category:</span>
            <span class="summary-value">${goalName}</span>
          </div>
          <div class="summary-row">
            <span class="summary-label">Total Records:</span>
            <span class="summary-value">${records.length}</span>
          </div>
          <div class="summary-row">
            <span class="summary-label">Total Savings:</span>
            <span class="summary-value">RM ${totalSavings.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</span>
          </div>
          <div class="summary-row">
            <span class="summary-label">Average per Record:</span>
            <span class="summary-value">RM ${(records.length > 0 ? totalSavings / records.length : 0).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</span>
          </div>
        </div>

        <h2 style="font-size: 18px; margin-bottom: 15px;">ðŸ“‹ Detailed Records</h2>
        <table>
          <thead>
            <tr>
              <th style="width: 5%;">No.</th>
              <th style="width: 25%;">Amount (RM)</th>
              <th style="width: 30%;">Date</th>
              <th style="width: 40%;">Notes</th>
            </tr>
          </thead>
          <tbody>
            ${recordsHtml}
          </tbody>
        </table>

        <div class="summary" style="background: #fff3cd; border-left: 4px solid #ffc107;">
          <div class="summary-row">
            <span class="summary-label" style="color: #856404;">ðŸ“Š Grand Total Savings:</span>
            <span style="color: #ffc107; font-weight: bold; font-size: 16px;">RM ${totalSavings.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</span>
          </div>
        </div>

        <div class="footer">
          <p>This report was automatically generated by NUR Investment Fund Management System</p>
          <p>Â© 2025 NUR Family | Investment & Savings Management</p>
          <p style="margin-top: 10px; color: #999;">For questions or clarifications, please contact the fund administrator.</p>
        </div>
      </div>
    </body>
    </html>
  `;

  return html;
};

/**
 * Generate HTML email report for all investment records
 */
const generateInvestmentEmailReport = (equities, bonds, alternatives, totalValue) => {
  const timestamp = new Date().toLocaleString('en-MY');
  const today = new Date().toLocaleDateString('en-MY', { year: 'numeric', month: 'long', day: 'numeric' });

  const equitiesHtml = equities.map((e, idx) => `
    <tr>
      <td style="padding: 10px; border-bottom: 1px solid #eee; font-size: 13px;">${idx + 1}</td>
      <td style="padding: 10px; border-bottom: 1px solid #eee; font-size: 13px;">${e.name}</td>
      <td style="padding: 10px; border-bottom: 1px solid #eee; text-align: right; font-size: 13px;">RM ${e.value.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</td>
      <td style="padding: 10px; border-bottom: 1px solid #eee; font-size: 13px;">${e.sector || '-'}</td>
    </tr>
  `).join('');

  const bondsHtml = bonds.map((b, idx) => `
    <tr>
      <td style="padding: 10px; border-bottom: 1px solid #eee; font-size: 13px;">${idx + 1}</td>
      <td style="padding: 10px; border-bottom: 1px solid #eee; font-size: 13px;">${b.name}</td>
      <td style="padding: 10px; border-bottom: 1px solid #eee; text-align: right; font-size: 13px;">RM ${b.value.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
      <td style="padding: 10px; border-bottom: 1px solid #eee; font-size: 13px;">${b.rating || '-'}</td>
    </tr>
  `).join('');

  const altHtml = alternatives.map((a, idx) => `
    <tr>
      <td style="padding: 10px; border-bottom: 1px solid #eee; font-size: 13px;">${idx + 1}</td>
      <td style="padding: 10px; border-bottom: 1px solid #eee; font-size: 13px;">${a.name}</td>
      <td style="padding: 10px; border-bottom: 1px solid #eee; text-align: right; font-size: 13px;">RM ${a.current_value.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
      <td style="padding: 10px; border-bottom: 1px solid #eee; font-size: 13px;">${a.asset_type || '-'}</td>
    </tr>
  `).join('');

  const equitiesTotal = equities.reduce((sum, e) => sum + e.value, 0);
  const bondsTotal = bonds.reduce((sum, b) => sum + b.value, 0);
  const altTotal = alternatives.reduce((sum, a) => sum + a.current_value, 0);

  const html = `
    <!DOCTYPE html>
    <html>
    <head>
      <meta charset="UTF-8">
      <style>
        body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }
        .container { max-width: 900px; margin: 0 auto; padding: 20px; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        .header h1 { margin: 0; font-size: 24px; }
        .header p { margin: 5px 0 0 0; font-size: 14px; opacity: 0.9; }
        .section { margin-bottom: 30px; }
        .section-title { background: #667eea; color: white; padding: 10px 15px; border-radius: 5px; font-weight: bold; margin-bottom: 15px; }
        .summary { background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .summary-row { display: flex; justify-content: space-between; margin: 8px 0; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 15px; background: white; font-size: 13px; }
        th { background: #667eea; color: white; padding: 10px; text-align: left; font-weight: bold; }
        .footer { text-align: center; padding: 20px 0; border-top: 1px solid #eee; color: #666; font-size: 12px; }
        .report-info { background: #e3f2fd; padding: 10px; border-radius: 5px; margin-bottom: 20px; font-size: 13px; }
        .total-box { background: #fff3cd; padding: 15px; border-radius: 8px; text-align: center; }
        .total-value { font-size: 24px; font-weight: bold; color: #ffc107; }
      </style>
    </head>
    <body>
      <div class="container">
        <div class="header">
          <h1>ðŸ“Š Investment Portfolio Report</h1>
          <p>NUR Investment Fund - Complete Portfolio Analysis</p>
        </div>

        <div class="report-info">
          <strong>Report Generated:</strong> ${timestamp}<br>
          <strong>Report Period:</strong> ${today}
        </div>

        <div class="section">
          <div class="section-title">ðŸ’¼ Equities (${equities.length} holdings)</div>
          <table>
            <thead>
              <tr>
                <th width="5%">No.</th>
                <th width="40%">Company</th>
                <th width="30%">Value (RM)</th>
                <th width="25%">Sector</th>
              </tr>
            </thead>
            <tbody>
              ${equitiesHtml}
            </tbody>
          </table>
          <div class="summary">
            <div class="summary-row">
              <span>Equities Total:</span>
              <span style="font-weight: bold; color: #667eea;">RM ${equitiesTotal.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
            </div>
          </div>
        </div>

        <div class="section">
          <div class="section-title">ðŸ’° Fixed Income (${bonds.length} holdings)</div>
          <table>
            <thead>
              <tr>
                <th width="5%">No.</th>
                <th width="40%">Bond</th>
                <th width="30%">Value (RM)</th>
                <th width="25%">Rating</th>
              </tr>
            </thead>
            <tbody>
              ${bondsHtml}
            </tbody>
          </table>
          <div class="summary">
            <div class="summary-row">
              <span>Fixed Income Total:</span>
              <span style="font-weight: bold; color: #667eea;">RM ${bondsTotal.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</span>
            </div>
          </div>
        </div>

        <div class="section">
          <div class="section-title">ðŸ’Ž Alternative Investments (${alternatives.length} holdings)</div>
          <table>
            <thead>
              <tr>
                <th width="5%">No.</th>
                <th width="40%">Investment</th>
                <th width="30%">Value (RM)</th>
                <th width="25%">Type</th>
              </tr>
            </thead>
            <tbody>
              ${altHtml}
            </tbody>
          </table>
          <div class="summary">
            <div class="summary-row">
              <span>Alternatives Total:</span>
              <span style="font-weight: bold; color: #667eea;">RM ${altTotal.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</span>
            </div>
          </div>
        </div>

        <div class="total-box">
          <p style="margin: 0 0 10px 0;">Total Portfolio Value</p>
          <div class="total-value">RM ${totalValue.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</div>
          <p style="margin: 10px 0 0 0; font-size: 12px; color: #666;">Equities: ${((equitiesTotal/totalValue)*100).toFixed(1)}% | Fixed Income: ${((bondsTotal/totalValue)*100).toFixed(1)}% | Alternatives: ${((altTotal/totalValue)*100).toFixed(1)}%</p>
        </div>

        <div class="footer">
          <p>This report was automatically generated by NUR Investment Fund Management System</p>
          <p>Â© 2025 NUR Family | Investment & Savings Management</p>
        </div>
      </div>
    </body>
    </html>
  `;

  return html;
};

module.exports = {
  generateSavingsEmailReport,
  generateInvestmentEmailReport
};
